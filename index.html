<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>üëΩ ALIEN DECODER ¬∑ CHAT UNLOCK</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* ----- RESET & BASE (same insane mobile style) ----- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background: #0a0f0f;
            font-family: 'Orbitron', sans-serif;
            color: #b7fff0;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
            padding: 10px;
        }
        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle at 20% 30%, #b5ffe0 1px, transparent 1px),
                        radial-gradient(circle at 80% 70%, #b0f0ff 1px, transparent 1px);
            background-size: 60px 60px, 100px 100px;
            animation: drift 90s linear infinite;
            opacity: 0.1;
            pointer-events: none;
            z-index: 0;
        }
        @keyframes drift {
            0% { transform: translate(0,0) rotate(0deg); }
            100% { transform: translate(-20%, -15%) rotate(2deg); }
        }
        .ufo {
            position: absolute;
            top: 10px;
            left: -150px;
            font-size: 2.5rem;
            filter: drop-shadow(0 0 5px #0ff);
            animation: fly 30s linear infinite;
            z-index: 5;
            opacity: 0.5;
        }
        .ufo2 {
            position: absolute;
            bottom: 50px;
            left: -200px;
            font-size: 2rem;
            filter: drop-shadow(0 0 5px #ffb3ff);
            animation: fly 40s linear reverse infinite;
            z-index: 5;
            opacity: 0.4;
        }
        @keyframes fly {
            0% { left: -200px; transform: scale(0.8); }
            100% { left: 120%; transform: scale(1); }
        }
        .game-container {
            position: relative;
            z-index: 20;
            max-width: 600px;
            margin: 10px auto;
            background: rgba(8, 20, 18, 0.95);
            backdrop-filter: blur(4px);
            border: 2px solid #1effd0;
            border-radius: 28px;
            padding: 18px;
            box-shadow: 0 0 30px #1effd0, inset 0 0 10px #1a4d47;
            display: flex;
            flex-direction: column;
            gap: 18px;
        }
        .mission-panel, .data-panel {
            width: 100%;
        }
        .mission-panel {
            background: #031010c9;
            border-radius: 22px;
            padding: 18px 15px;
            border: 1px solid #2affbf;
        }
        .glitch {
            font-size: 1.5rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin: 15px 0;
            animation: glitch 2.2s infinite;
            word-break: break-word;
            line-height: 1.3;
        }
        @keyframes glitch {
            0% { text-shadow: 2px 0 #ff00c1, -1px 0 #00ffea; }
            25% { text-shadow: -2px 0 #ff6600, 1px 0 cyan; }
            50% { text-shadow: 1px 1px magenta, -1px -1px lime; }
            75% { text-shadow: -2px 1px blue, 2px -1px red; }
            100% { text-shadow: 1px 0 #00ffc3, -1px 0 #ff00e6; }
        }
        .options-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px 0;
        }
        .options-grid button {
            background: transparent;
            border: 2px solid #2affbf;
            border-radius: 50px;
            padding: 16px 18px;
            font-family: 'Orbitron', sans-serif;
            color: #d5fffb;
            font-weight: 700;
            font-size: 1rem;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: 0.2s;
            text-align: left;
            position: relative;
            min-height: 60px;
            -webkit-tap-highlight-color: transparent;
        }
        .options-grid button:active {
            background: #1effd0;
            color: #031010;
            transform: scale(0.98);
        }
        .correct {
            background: #00d4a0 !important;
            color: #000 !important;
            border-color: #ffff !important;
        }
        .correct::after {
            content: " ‚úì";
            font-size: 1.6rem;
            font-weight: bold;
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
        }
        .wrong {
            background: #b41e5c !important;
            color: black !important;
            border-color: #ff99cc !important;
            text-decoration: line-through wavy #fff;
        }
        .hint-area {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 15px 0;
        }
        .hint-btn {
            background: #160f2b;
            border: 2px dashed #fe0;
            border-radius: 50px;
            padding: 16px;
            font-weight: bold;
            color: #fffdab;
            font-size: 1.2rem;
            cursor: pointer;
            transition: 0.2s;
            width: 100%;
            min-height: 60px;
        }
        .hint-btn:active {
            background: #fffd9f;
            color: black;
        }
        .hint-btn:disabled {
            opacity: 0.4;
            filter: grayscale(0.8);
            pointer-events: none;
        }
        #hintCount {
            background: #000;
            padding: 12px;
            border-radius: 50px;
            text-align: center;
            font-size: 1.2rem;
            border: 1px solid #fe0;
        }
        #hintBox {
            background: #0f2b28;
            border-radius: 30px;
            padding: 15px;
            font-size: 1.1rem;
            border-left: 8px solid #fe0;
            margin: 8px 0;
            color: #fffbbc;
            min-height: 60px;
            transition: opacity 0.3s;
            word-break: break-word;
        }
        .stats {
            display: flex;
            justify-content: space-between;
            font-size: 1.1rem;
            margin-top: 20px;
            border-top: 2px solid #0ff;
            padding-top: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .data-panel {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }
        .lexicon-panel, .leaderboard-panel, .chat-panel {
            background: #0b1d1a;
            border: 2px solid #bcfffd;
            border-radius: 24px;
            padding: 18px 12px;
        }
        .lexicon-panel h2, .leaderboard-panel h2, .chat-panel h2 {
            font-size: 1.3rem;
            color: #fbffa3;
            border-bottom: 2px solid #78ffe0;
            padding-bottom: 6px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        #lexiconList {
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.9rem;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .lex-item {
            background: #17302b;
            border-radius: 30px;
            padding: 8px 12px;
            border: 1px solid #0ff;
            display: flex;
            justify-content: space-between;
        }
        .lex-alien { font-weight: bold; color: #ffbc6e; }
        .lex-human { color: #b3ffe0; }
        #leaderboardList {
            list-style: none;
            font-size: 1rem;
        }
        #leaderboardList li {
            padding: 8px 5px;
            border-bottom: 1px solid #49c6b3;
            display: flex;
            justify-content: space-between;
        }
        #leaderboardList li::before {
            content: "üëæ";
            margin-right: 8px;
        }
        .reset-btn {
            background: transparent;
            border: 2px solid #ff4de1;
            color: #ffb3fd;
            border-radius: 50px;
            padding: 14px;
            margin-top: 15px;
            width: 100%;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1rem;
            min-height: 54px;
        }
        .reset-btn:active {
            background: #ff6ef0;
            color: black;
        }
        .alien-win {
            font-size: 2rem;
            text-align: center;
            color: #f0f;
            text-shadow: 0 0 20px cyan;
            animation: glitch 1s infinite;
            margin: 20px 0;
        }
        .correct-message {
            background: #0f0;
            color: black;
            font-weight: bold;
            padding: 10px;
            border-radius: 50px;
            margin: 5px 0;
            text-align: center;
        }
        /* Chat panel specific */
        .chat-panel input, .chat-panel button {
            font-family: 'Orbitron', sans-serif;
        }
        #chatMessages {
            background: #0f2b28;
            border-radius: 20px;
            padding: 12px;
            height: 160px;
            overflow-y: auto;
            margin-bottom: 12px;
            font-size: 0.9rem;
            border: 1px solid #0ff;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .chat-message {
            padding: 6px 12px;
            border-radius: 30px;
            max-width: 80%;
            word-break: break-word;
        }
        .chat-message.user {
            background: #1d4a47;
            align-self: flex-end;
            color: #e0ffe0;
            border: 1px solid #0ff;
        }
        .chat-message.alien {
            background: #2a1f3a;
            align-self: flex-start;
            color: #ffde9e;
            border: 1px solid #fe0;
        }
        #chatLock p {
            margin-bottom: 10px;
            color: #fffdab;
        }
        #chatPassword {
            width: 100%;
            padding: 14px;
            border-radius: 50px;
            background: #000;
            color: #0ff;
            border: 2px solid #fe0;
            margin-bottom: 12px;
            font-size: 1rem;
        }
        #unlockChatBtn {
            background: #160f2b;
            border: 2px solid #fe0;
        }
        #chatError {
            color: #ff7b9c;
            min-height: 24px;
            margin-top: 8px;
        }
        #completionBanner {
            background: #ffd966;
            color: #000;
            font-weight: bold;
            padding: 15px;
            border-radius: 50px;
            margin-bottom: 15px;
            text-align: center;
            border: 2px solid #f0f;
            word-break: break-word;
        }
        @media (max-width: 480px) {
            .game-container { padding: 12px; }
            .glitch { font-size: 1.3rem; }
            .options-grid button { font-size: 0.9rem; padding: 14px; }
        }
    </style>
</head>
<body>
<div class="ufo">üõ∏</div>
<div class="ufo2">üëΩ</div>

<div class="game-container" id="mainGameContainer">
    <div class="mission-panel" id="missionPanel">
        <h1 style="font-size: 1.8rem;">‚ó§ ALIEN DECODER ‚ó¢</h1>
        <div id="alienText" class="glitch">...</div>
        <div id="options" class="options-grid"></div>
        <div class="hint-area">
            <button class="hint-btn" id="hintButton" onclick="useHint()">üí° DECODE HINT</button>
            <span id="hintCount">üß™ 2</span>
        </div>
        <div id="hintBox">üëΩ‚Äî press hint to decrypt ‚Äî</div>
        <div class="stats">
            <span id="score">üî∞ SCORE: 0</span>
            <span id="questionsLeft">üì° LEFT: 16</span>
        </div>
        <button class="reset-btn" onclick="resetGame()">‚ü≤ RESTART MISSION ‚ü≤</button>
    </div>

    <div class="data-panel">
        <div class="lexicon-panel">
            <h2>üìñ ALIEN LEXICON</h2>
            <div id="lexiconList">‚Äî decode to reveal ‚Äî</div>
        </div>
        <div class="leaderboard-panel">
            <h2>üèÜ COSMIC LEADERBOARD</h2>
            <ol id="leaderboardList">loading from galaxy...</ol>
            <div style="font-size:0.7rem; margin-top:8px;">top 10 ¬∑ GAS sync</div>
        </div>
        <!-- NEW: ALIEN CHAT PANEL (always visible but locked) -->
        <div class="chat-panel" id="chatPanel">
            <h2>üëΩ ALIEN CHAT</h2>
            <div id="chatLock">
                <p>üîí Decode all 16 phrases correctly to receive one‚Äëtime password.</p>
                <input type="text" id="chatPassword" placeholder="enter password" autocomplete="off">
                <button class="hint-btn" id="unlockChatBtn">üöÄ UNLOCK CHAT</button>
                <div id="chatError"></div>
            </div>
            <div id="chatInterface" style="display: none;">
                <div id="chatMessages">
                    <div class="chat-message alien">üëΩ Zyra'k tul venar ... (alien awaits)</div>
                </div>
                <div style="display:flex; gap:8px;">
                    <input type="text" id="chatInput" placeholder="type message..." style="flex:1; padding:14px; border-radius:50px; background:#000; color:#0ff; border:2px solid #0ff;">
                    <button class="hint-btn" id="sendChatBtn" style="width:auto; padding:14px 20px;">‚û§</button>
                </div>
            </div>
        </div>
    </div>
</div>

<audio id="correctSound" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.wav"></audio>
<audio id="wrongSound" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-retro-changing-tab-206.wav"></audio>

<script>
    // ================= CONFIG =================
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwLdsXN40Bzf68l2eloIiZs3Vk_OwQERJdqMbsGVm0uGz4N-3jfKmlZD9tFlTEOUfTSvQ/exec";  // (replace with your own if needed)

    const lexiconDB = {
        "Zyra'k": "we", "tul": "come", "venar": "peace",
        "Kora": "ship", "xyn": "has/have", "talor": "landed",
        "Velan": "prepare", "torix": "for", "za": "departure",
        "Xenar": "energy", "vol": "levels/are", "ti'ra": "rising",
        "Tor": "activate", "venak": "shield", "zil": "now",
        "Nefar": "danger", "kros": "alien", "mek": "must",
        "vorta": "return", "lyss": "moon", "bor": "base",
        "zynth": "secret", "orok": "code", "vix": "crystal",
        "morph": "change", "quantum": "dimension"
    };

    const questions = [
        { alien: "Zyra'k tul venar", answer: "We come peace" },
        { alien: "Kora xyn talor", answer: "Ship has landed" },
        { alien: "Velan torix za", answer: "Prepare for departure" },
        { alien: "Xenar vol ti'ra", answer: "Energy levels rising" },
        { alien: "Tor venak zil", answer: "Activate shield now" },
        { alien: "Nefar kros mek vorta", answer: "Danger alien must return" },
        { alien: "Zyra'k vol lyss bor", answer: "We are moon base" },
        { alien: "Kora torix venak", answer: "Ship for shield" },
        { alien: "Xenar bor ti'ra", answer: "Energy base rising" },
        { alien: "Venak tul kros", answer: "Shield come alien" },
        { alien: "Lyss bor mek za", answer: "Moon base must departure" },
        { alien: "Velan vorta zil", answer: "Prepare return now" },
        { alien: "Zynth orok vix", answer: "Secret code crystal" },
        { alien: "Morph quantum xenar", answer: "Change dimension energy" },
        { alien: "Nefar bor ti'ra", answer: "Danger base rising" },
        { alien: "Zyra'k mek venak", answer: "We must shield" }
    ];

    // ---------- Game state ----------
    let score = 0;
    let hintsLeft = 2;
    let usedIndexes = JSON.parse(localStorage.getItem("usedQuestions")) || [];
    let currentQuestionIndex = null;
    let discoveredWords = JSON.parse(localStorage.getItem("alienLexicon")) || {};

    // ---------- Chat state ----------
    let chatPassword = localStorage.getItem("alienChatPassword") || null;
    let chatUnlocked = localStorage.getItem("chatUnlocked") === "true";
    let allCorrectCompleted = localStorage.getItem("allCorrectCompleted") === "true"; // flag for perfect finish

    // ---------- Helper functions ----------
    function saveLexicon() {
        localStorage.setItem("alienLexicon", JSON.stringify(discoveredWords));
        renderLexicon();
    }

    function addWordToLexicon(alienWord, translation) {
        if (!discoveredWords[alienWord] && translation) {
            discoveredWords[alienWord] = translation;
        }
    }

    function learnCurrentSentence() {
        if (currentQuestionIndex === null) return;
        const alienWords = questions[currentQuestionIndex].alien.split(' ');
        alienWords.forEach(aw => {
            if (lexiconDB[aw]) addWordToLexicon(aw, lexiconDB[aw]);
        });
        saveLexicon();
    }

    function renderLexicon() {
        const container = document.getElementById('lexiconList');
        if (!container) return;
        const entries = Object.entries(discoveredWords);
        if (entries.length === 0) {
            container.innerHTML = '<div style="color:#6f9f9a;">üëΩ‚Äî decode to reveal ‚Äî</div>';
            return;
        }
        container.innerHTML = entries.map(([alien, human]) => 
            `<div class="lex-item"><span class="lex-alien">${alien}</span> <span class="lex-human">‚á¢ ${human}</span></div>`
        ).join('');
    }

    // ---------- Leaderboard ----------
    function fetchLeaderboard() {
        const script = document.createElement('script');
        const callbackName = 'jsonp_callback_' + Date.now();
        window[callbackName] = function(data) {
            const listEl = document.getElementById('leaderboardList');
            if (!listEl) return;
            if (!data || data.length === 0) {
                listEl.innerHTML = '<li style="color:gray;">no scores yet</li>';
            } else {
                listEl.innerHTML = data.map(entry => 
                    `<li><span>${entry.name}</span> <span style="color:#fbffb3;">${entry.score}</span></li>`
                ).join('');
            }
            delete window[callbackName];
            document.body.removeChild(script);
        };
        script.src = `${GAS_URL}?callback=${callbackName}`;
        document.body.appendChild(script);
    }

    async function submitScore(playerName, finalScore) {
        try {
            await fetch(GAS_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: playerName, score: finalScore })
            });
            setTimeout(fetchLeaderboard, 2000);
        } catch (e) {
            console.warn('Score submission failed');
        }
    }

    // ---------- Chat functions ----------
    function generateChatPassword() {
        return "ALIEN-" + Math.random().toString(36).substring(2,8).toUpperCase();
    }

    function showChatPasswordMessage() {
        const chatLockDiv = document.getElementById('chatLock');
        // inject password hint into chat panel
        let msgDiv = document.getElementById('chatPasswordHint');
        if (!msgDiv) {
            msgDiv = document.createElement('p');
            msgDiv.id = 'chatPasswordHint';
            msgDiv.style.background = '#ffd966';
            msgDiv.style.color = '#000';
            msgDiv.style.padding = '12px';
            msgDiv.style.borderRadius = '50px';
            msgDiv.style.marginBottom = '15px';
            msgDiv.style.border = '2px solid #f0f';
            chatLockDiv.insertBefore(msgDiv, chatLockDiv.firstChild);
        }
        msgDiv.innerHTML = `üîë ONE‚ÄëTIME PASSWORD: <strong>${chatPassword}</strong> (use below)`;
    }

    function unlockChat(entered) {
        if (entered === chatPassword) {
            chatUnlocked = true;
            localStorage.setItem("chatUnlocked", "true");
            document.getElementById('chatLock').style.display = 'none';
            document.getElementById('chatInterface').style.display = 'block';
            // add welcome message
            const msgBox = document.getElementById('chatMessages');
            msgBox.innerHTML = '<div class="chat-message alien">üëΩ Zyra\'k tul venar. You may speak.</div>';
        } else {
            document.getElementById('chatError').innerText = '‚ùå invalid password';
        }
    }

    // simple chat
    function sendChat() {
        const input = document.getElementById('chatInput');
        const txt = input.value.trim();
        if (!txt) return;
        const msgBox = document.getElementById('chatMessages');
        // user message
        const userDiv = document.createElement('div');
        userDiv.className = 'chat-message user';
        userDiv.innerText = txt;
        msgBox.appendChild(userDiv);
        input.value = '';

        // alien response (random from lexicon or funny)
        setTimeout(() => {
            const alienDiv = document.createElement('div');
            alienDiv.className = 'chat-message alien';
            const responses = [
                "Zyra'k tul ...", "Kora xyn talor?", "Xenar vol ti'ra", "Nefar kros?",
                "Venak zil.", "Lyss bor mek.", "üëΩüëΩüëΩ", "quantum morph"
            ];
            alienDiv.innerText = "üëΩ " + responses[Math.floor(Math.random() * responses.length)];
            msgBox.appendChild(alienDiv);
            msgBox.scrollTop = msgBox.scrollHeight;
        }, 600);
        msgBox.scrollTop = msgBox.scrollHeight;
    }

    // ---------- Game mechanics ----------
    function shuffle(arr) { return arr.sort(() => Math.random() - 0.5); }

    function updateLeftCount() {
        const left = questions.length - usedIndexes.length;
        document.getElementById('questionsLeft').innerText = `üì° LEFT: ${left}`;
        return left;
    }

    // modified gameComplete: no full overwrite, just banner + disable + chat if perfect
    function gameComplete() {
        // submit score to leaderboard
        const playerName = prompt("üëæ MISSION COMPLETE! Enter your name for the leaderboard:", "Explorer");
        submitScore(playerName ? playerName.trim() || "Anonymous" : "Anonymous", score);

        // disable all interactive elements
        document.querySelectorAll("#options button, #hintButton").forEach(el => el.disabled = true);

        // Check if all answers correct
        if (score === questions.length) {
            allCorrectCompleted = true;
            localStorage.setItem("allCorrectCompleted", "true");

            // generate password if not exists
            if (!chatPassword) {
                chatPassword = generateChatPassword();
                localStorage.setItem("alienChatPassword", chatPassword);
            }

            // show banner in mission panel
            let banner = document.getElementById('completionBanner');
            if (!banner) {
                banner = document.createElement('div');
                banner.id = 'completionBanner';
                document.getElementById('missionPanel').insertBefore(banner, document.getElementById('missionPanel').firstChild);
            }
            banner.innerHTML = `üéâ PERFECT DECODE! ONE‚ÄëTIME PASSWORD: <strong>${chatPassword}</strong> üéâ`;

            // show password hint in chat lock
            showChatPasswordMessage();

            // if already unlocked via storage, show chat
            if (chatUnlocked) {
                document.getElementById('chatLock').style.display = 'none';
                document.getElementById('chatInterface').style.display = 'block';
            }
        } else {
            // normal completion without perfect score
            let banner = document.getElementById('completionBanner');
            if (!banner) {
                banner = document.createElement('div');
                banner.id = 'completionBanner';
                document.getElementById('missionPanel').insertBefore(banner, document.getElementById('missionPanel').firstChild);
            }
            banner.innerHTML = `üëæ MISSION OVER ¬∑ FINAL SCORE: ${score}/${questions.length}`;
        }
    }

    function getRandomQuestion() {
        if (usedIndexes.length >= questions.length) {
            gameComplete();
            return;
        }

        let idx;
        do {
            idx = Math.floor(Math.random() * questions.length);
        } while (usedIndexes.includes(idx));

        currentQuestionIndex = idx;
        usedIndexes.push(idx);
        localStorage.setItem("usedQuestions", JSON.stringify(usedIndexes));
        showQuestion();
        updateLeftCount();
    }

    function showQuestion() {
        document.getElementById("hintBox").innerText = "üëΩ‚Äî press hint to decrypt ‚Äî";
        const q = questions[currentQuestionIndex];
        document.getElementById("alienText").innerText = q.alien;

        let otherAnswers = questions.map(q => q.answer).filter(a => a !== q.answer);
        otherAnswers = shuffle(otherAnswers).slice(0, 4);
        let options = [q.answer, ...otherAnswers];
        options = shuffle(options);

        const optionsDiv = document.getElementById("options");
        optionsDiv.innerHTML = "";
        options.forEach(opt => {
            const btn = document.createElement("button");
            btn.innerText = opt;
            btn.onclick = () => checkAnswer(btn, opt);
            optionsDiv.appendChild(btn);
        });
        document.getElementById("hintCount").innerText = `üß™ ${hintsLeft}`;
        document.getElementById("hintButton").disabled = (hintsLeft === 0);
    }

    function checkAnswer(btn, selected) {
        const correct = questions[currentQuestionIndex].answer;
        const allBtns = document.querySelectorAll("#options button");
        allBtns.forEach(b => b.disabled = true);

        if (selected === correct) {
            btn.classList.add("correct");
            score++;
            document.getElementById("correctSound").play();
            learnCurrentSentence();
            const msg = document.createElement("div");
            msg.className = "correct-message";
            msg.innerText = "‚úî CORRECT!";
            document.getElementById("hintBox").innerHTML = "";
            document.getElementById("hintBox").appendChild(msg);
            setTimeout(() => {
                if (document.getElementById("hintBox").contains(msg))
                    document.getElementById("hintBox").innerHTML = "üëΩ‚Äî press hint to decrypt ‚Äî";
            }, 1500);
        } else {
            btn.classList.add("wrong");
            document.getElementById("wrongSound").play();
            allBtns.forEach(b => {
                if (b.innerText === correct) b.classList.add("correct");
            });
        }
        document.getElementById("score").innerText = "üî∞ SCORE: " + score;

        setTimeout(() => {
            if (usedIndexes.length < questions.length) getRandomQuestion();
            else gameComplete();
        }, 2000);
    }

    function useHint() {
        if (hintsLeft <= 0 || currentQuestionIndex === null) {
            document.getElementById("hintBox").innerText = "‚ùå no hints left!";
            setTimeout(() => {
                if (document.getElementById("hintBox").innerText === "‚ùå no hints left!")
                    document.getElementById("hintBox").innerText = "üëΩ‚Äî press hint to decrypt ‚Äî";
            }, 3000);
            return;
        }
        const q = questions[currentQuestionIndex];
        const alienWords = q.alien.split(' ');
        const unknown = alienWords.filter(w => !discoveredWords[w] && lexiconDB[w]);
        if (unknown.length === 0) {
            document.getElementById("hintBox").innerText = `üîç translation: ${q.answer.length} chars, starts with '${q.answer[0]}'`;
        } else {
            const randomWord = unknown[Math.floor(Math.random() * unknown.length)];
            const meaning = lexiconDB[randomWord] || '?';
            addWordToLexicon(randomWord, meaning);
            saveLexicon();
            document.getElementById("hintBox").innerHTML = `üß© <strong>${randomWord}</strong> ‚á¢ ${meaning}`;
        }
        hintsLeft--;
        document.getElementById("hintCount").innerText = `üß™ ${hintsLeft}`;
        if (hintsLeft === 0) document.getElementById("hintButton").disabled = true;

        setTimeout(() => {
            document.getElementById("hintBox").innerHTML = "üëΩ‚Äî press hint to decrypt ‚Äî";
        }, 5000);
    }

    function resetGame() {
        localStorage.removeItem("usedQuestions");
        localStorage.removeItem("alienLexicon");
        localStorage.removeItem("alienChatPassword");
        localStorage.removeItem("chatUnlocked");
        localStorage.removeItem("allCorrectCompleted");
        usedIndexes = [];
        discoveredWords = {};
        score = 0;
        hintsLeft = 2;
        currentQuestionIndex = null;
        chatPassword = null;
        chatUnlocked = false;
        allCorrectCompleted = false;

        // rebuild mission panel (simple way)
        document.getElementById('missionPanel').innerHTML = `
            <h1 style="font-size: 1.8rem;">‚ó§ ALIEN DECODER ‚ó¢</h1>
            <div id="alienText" class="glitch">...</div>
            <div id="options" class="options-grid"></div>
            <div class="hint-area">
                <button class="hint-btn" id="hintButton" onclick="useHint()">üí° DECODE HINT</button>
                <span id="hintCount">üß™ 2</span>
            </div>
            <div id="hintBox">üëΩ‚Äî press hint to decrypt ‚Äî</div>
            <div class="stats">
                <span id="score">üî∞ SCORE: 0</span>
                <span id="questionsLeft">üì° LEFT: 16</span>
            </div>
            <button class="reset-btn" onclick="resetGame()">‚ü≤ RESTART MISSION ‚ü≤</button>
        `;
        // reset chat panel
        document.getElementById('chatLock').style.display = 'block';
        document.getElementById('chatInterface').style.display = 'none';
        document.getElementById('chatPassword').value = '';
        document.getElementById('chatError').innerText = '';
        const hintMsg = document.getElementById('chatPasswordHint');
        if (hintMsg) hintMsg.remove();
        renderLexicon();
        getRandomQuestion();
        updateLeftCount();
    }

    // ---------- Initialisation ----------
    window.onload = function() {
        fetchLeaderboard();
        renderLexicon();

        // chat unlock button
        document.getElementById('unlockChatBtn').addEventListener('click', function() {
            const pwd = document.getElementById('chatPassword').value.trim();
            unlockChat(pwd);
        });

        // send chat button
        document.getElementById('sendChatBtn').addEventListener('click', sendChat);
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendChat();
        });

        // check if already perfect completed
        if (localStorage.getItem("allCorrectCompleted") === "true") {
            allCorrectCompleted = true;
            chatPassword = localStorage.getItem("alienChatPassword");
            if (chatPassword) {
                showChatPasswordMessage();
            }
            if (localStorage.getItem("chatUnlocked") === "true") {
                chatUnlocked = true;
                document.getElementById('chatLock').style.display = 'none';
                document.getElementById('chatInterface').style.display = 'block';
            }
        }

        // start or resume game
        if (usedIndexes.length >= questions.length) {
            // if already finished, just show final state without resetting
            const left = questions.length - usedIndexes.length;
            if (left <= 0) {
                // need to rebuild mission panel properly? but we can just call gameComplete logic
                // but we need to show score from storage? score is in memory only; we reload from storage? we have score variable =0 initially.
                // Better to recover score from somewhere? We'll just reset if finished to avoid inconsistency.
                resetGame();
            } else {
                getRandomQuestion();
            }
        } else {
            getRandomQuestion();
        }

        setInterval(fetchLeaderboard, 30000);
    };
</script>
</body>
</html>
